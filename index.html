<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planet Ideas v2.1 - Ambient Idea Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
        }

        #canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            cursor: default;
        }

        /* Floating Action Button */
        #addButton {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 32px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 100;
        }

        #addButton:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }

        #addButton:active {
            transform: scale(0.95);
        }

        /* Side Panel */
        #sidePanel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: right 0.3s ease;
            z-index: 200;
            display: flex;
            flex-direction: column;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.5);
        }

        #sidePanel.open {
            right: 0;
        }

        #sidePanelToggle {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 80px;
            background: rgba(102, 126, 234, 0.8);
            border: none;
            border-radius: 8px 0 0 8px;
            color: white;
            cursor: pointer;
            z-index: 199;
            font-size: 18px;
            transition: background 0.2s, right 0.3s;
        }

        #sidePanelToggle:hover {
            background: rgba(102, 126, 234, 1);
        }

        #sidePanelToggle.panel-open {
            right: 350px;
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header h2 {
            font-size: 20px;
            margin-bottom: 5px;
        }

        .panel-header p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .planet-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            border: 2px solid transparent;
        }

        .planet-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-5px);
        }

        .planet-item.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .planet-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .planet-item-name {
            font-weight: bold;
            font-size: 14px;
            flex: 1;
        }

        .planet-item-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .planet-item-stats {
            display: flex;
            gap: 15px;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.7);
        }

        .planet-item-stat {
            display: flex;
            flex-direction: column;
        }

        .planet-item-stat-label {
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 2px;
        }

        .delete-btn {
            background: rgba(220, 38, 38, 0.8);
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 8px;
            transition: background 0.2s;
        }

        .delete-btn:hover {
            background: rgba(220, 38, 38, 1);
        }

        /* Modal */
        #modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 300;
        }

        #modal.show {
            display: flex;
        }

        .modal-content {
            background: rgba(30, 30, 40, 0.98);
            border-radius: 12px;
            padding: 30px;
            width: 400px;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-content h2 {
            margin-bottom: 20px;
            font-size: 22px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group select option {
            background: #1e1e28;
            color: white;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* Info Panel (attached to planet) */
        .info-panel {
            position: absolute;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            min-width: 200px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            pointer-events: all;
            z-index: 1000;
        }

        .info-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
            word-wrap: break-word;
        }

        .info-panel-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 12px;
            font-size: 12px;
        }

        .info-panel-stat {
            display: flex;
            flex-direction: column;
        }

        .info-panel-stat-label {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 2px;
        }

        .info-panel-stat-value {
            font-weight: bold;
        }

        .info-panel-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .info-panel-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: opacity 0.2s;
        }

        .info-panel-btn:hover {
            opacity: 0.8;
        }

        .info-panel-edit {
            background: #667eea;
            color: white;
        }

        .info-panel-delete {
            background: rgba(220, 38, 38, 0.8);
            color: white;
        }

        .info-panel-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Panel Controls */
        .panel-controls {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-btn {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
            margin-bottom: 8px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar styling */
        .panel-content::-webkit-scrollbar {
            width: 6px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .panel-content::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Custom Confirmation Dialog */
        #confirmDialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 400;
        }

        #confirmDialog.show {
            display: flex;
        }

        .confirm-content {
            background: rgba(30, 30, 40, 0.98);
            border-radius: 12px;
            padding: 25px;
            width: 350px;
            max-width: 90vw;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .confirm-content h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #fff;
        }

        .confirm-content p {
            margin-bottom: 20px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .confirm-buttons {
            display: flex;
            gap: 10px;
        }

        .confirm-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        .confirm-btn:hover {
            opacity: 0.8;
        }

        .confirm-btn-delete {
            background: rgba(220, 38, 38, 0.9);
            color: white;
        }

        .confirm-btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <button id="addButton" title="Add New Idea">+</button>
    
    <button id="sidePanelToggle">â˜°</button>
    
    <div id="sidePanel">
        <div class="panel-header">
            <h2>Your Ideas</h2>
            <p id="planetCount">0 planets orbiting</p>
        </div>
        <div class="panel-content" id="planetList"></div>
        <div class="panel-controls">
            <button class="control-btn" id="saveProfileBtn">ðŸ’¾ Save Profile</button>
            <button class="control-btn" id="loadProfileBtn">ðŸ“‚ Load Profile</button>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h2 id="modalTitle">Add New Idea</h2>
            <form id="planetForm">
                <div class="form-group">
                    <label for="planetName">Idea Name</label>
                    <input type="text" id="planetName" placeholder="e.g., Organize room ðŸ§¹" required maxlength="50">
                </div>
                <div class="form-group">
                    <label for="planetImportance">Importance (1-10)</label>
                    <select id="planetImportance" required>
                        <option value="">Select...</option>
                        <option value="1">1 - Minimal</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 - Moderate</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10 - Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planetUrgency">Urgency (1-10)</label>
                    <select id="planetUrgency" required>
                        <option value="">Select...</option>
                        <option value="1">1 - Quick reminder</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5 - Moderate</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10 - Constant presence</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="planetInterval">Off-screen Interval (1-60 seconds)</label>
                    <input type="number" id="planetInterval" min="1" max="60" step="0.1" placeholder="Auto" value="">
                    <small style="color: rgba(255,255,255,0.5); font-size: 11px; margin-top: 4px; display: block;">Leave blank for automatic based on urgency</small>
                </div>
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Create Planet</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmDialog">
        <div class="confirm-content">
            <h3>Delete Planet</h3>
            <p id="confirmMessage">Are you sure you want to delete this planet?</p>
            <div class="confirm-buttons">
                <button class="confirm-btn confirm-btn-cancel" id="confirmCancel">Cancel</button>
                <button class="confirm-btn confirm-btn-delete" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            MIN_SIZE: 30,
            MAX_SIZE: 400,
            MIN_SPEED: 1, // Speed for urgency 10 (slowest, 60 seconds)
            MAX_SPEED: 60, // Speed for urgency 1 (fastest, 1 second)
            BACKGROUND_SCALE: 0.7,
            BACKGROUND_OPACITY: 0.6,
            BACKGROUND_SPEED_MULTIPLIER: 0.7,
            STAR_COUNT: 200,
            GLOW_RADIUS: 20
        };

        // ==================== STATE ====================
        let canvas, ctx;
        let planets = [];
        let stars = [];
        let selectedPlanetId = null;
        let activePlanetInfo = null;
        let editingPlanetId = null;
        let confirmCallback = null;

        // ==================== CONFIRMATION DIALOG ====================
        function showConfirmDialog(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmDialog').classList.add('show');
            confirmCallback = onConfirm;
        }

        function hideConfirmDialog() {
            document.getElementById('confirmDialog').classList.remove('show');
            confirmCallback = null;
        }

        function handleConfirmDelete() {
            if (confirmCallback) {
                confirmCallback();
            }
            hideConfirmDialog();
        }

        function handleCancelDelete() {
            hideConfirmDialog();
        }

        // ==================== INITIALIZATION ====================
        function init() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            generateStars();
            loadFromLocalStorage();
            
            // Event listeners
            document.getElementById('addButton').addEventListener('click', openAddModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            
            // Form submission - use both methods to be safe
            const form = document.getElementById('planetForm');
            form.addEventListener('submit', handleFormSubmit);
            
            // Also add direct handler on submit button as backup
            document.getElementById('submitBtn').addEventListener('click', (e) => {
                console.log('Submit button clicked directly');
                // Check if this is a form submission or direct click
                const form = document.getElementById('planetForm');
                if (form.checkValidity()) {
                    handleFormSubmit(e);
                } else {
                    // Let HTML5 validation run
                    form.reportValidity();
                }
            });
            
            document.getElementById('sidePanelToggle').addEventListener('click', toggleSidePanel);
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            document.getElementById('loadProfileBtn').addEventListener('click', loadProfile);
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousemove', handleCanvasHover);
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target.id === 'modal') closeModal();
            });
            
            document.getElementById('confirmDelete').addEventListener('click', handleConfirmDelete);
            document.getElementById('confirmCancel').addEventListener('click', handleCancelDelete);
            document.getElementById('confirmDialog').addEventListener('click', (e) => {
                if (e.target.id === 'confirmDialog') hideConfirmDialog();
            });
            
            // Start animation
            animate();
            
            console.log('%c=== Planet Ideas v2.1 Initialized ===', 'color: #667eea; font-size: 16px; font-weight: bold;');
            console.log('Current planet count:', planets.length);
            console.log('Canvas size:', canvas.width, 'x', canvas.height);
            console.log('Form element found:', !!document.getElementById('planetForm'));
        }

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        function generateStars() {
            stars = [];
            for (let i = 0; i < CONFIG.STAR_COUNT; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 1.5 + 0.5,
                    twinkle: Math.random() * Math.PI * 2,
                    twinkleSpeed: Math.random() * 0.02 + 0.01
                });
            }
        }

        // ==================== PLANET MANAGEMENT ====================
        function createPlanet(name, importance, urgency, customInterval = null) {
            const id = Date.now() + Math.random();
            const color = generatePlanetColor();
            const size = mapImportanceToSize(importance);
            const speed = mapUrgencyToSpeed(urgency);
            const interval = customInterval !== null ? customInterval : calculateDefaultInterval(urgency, speed);
            const orbitPath = generateOrbitPath();
            
            const planet = {
                id,
                name,
                importance: parseInt(importance),
                urgency: parseInt(urgency),
                interval: parseFloat(interval),
                color,
                size,
                speed,
                orbitPath,
                phase: 'foreground', // 'foreground' or 'background'
                direction: 1, // 1 for right, -1 for left
                progress: 0, // 0 to 1
                waitTime: 0,
                hovering: false
            };
            
            planets.push(planet);
            console.log('Planet created:', planet);
            saveToLocalStorage();
            updatePlanetList();
            return planet;
        }

        function calculateDefaultInterval(urgency, speed) {
            // Simple stepped intervals based on urgency
            // High urgency (9-10) = short interval (1s) - frequent reminders
            // Low urgency (1-2) = long interval (5s) - less frequent
            if (urgency >= 9) return 1;
            if (urgency >= 7) return 2;
            if (urgency >= 5) return 3;
            if (urgency >= 3) return 4;
            return 5; // urgency 1-2
        }

        function deletePlanet(id) {
            planets = planets.filter(p => p.id !== id);
            if (activePlanetInfo && activePlanetInfo.id === id) {
                activePlanetInfo = null;
            }
            if (selectedPlanetId === id) {
                selectedPlanetId = null;
            }
            saveToLocalStorage();
            updatePlanetList();
        }

        function updatePlanet(id, name, importance, urgency, customInterval = null) {
            console.log('updatePlanet called with:', { id, name, importance, urgency, customInterval });
            const planet = planets.find(p => p.id === id);
            if (planet) {
                console.log('Planet before update:', { 
                    name: planet.name, 
                    importance: planet.importance, 
                    urgency: planet.urgency,
                    size: planet.size,
                    speed: planet.speed,
                    interval: planet.interval
                });
                
                planet.name = name;
                planet.importance = parseInt(importance);
                planet.urgency = parseInt(urgency);
                planet.size = mapImportanceToSize(importance);
                planet.speed = mapUrgencyToSpeed(urgency);
                planet.interval = customInterval !== null ? parseFloat(customInterval) : calculateDefaultInterval(urgency, planet.speed);
                
                console.log('Planet after update:', { 
                    name: planet.name, 
                    importance: planet.importance, 
                    urgency: planet.urgency,
                    size: planet.size,
                    speed: planet.speed,
                    interval: planet.interval
                });
                
                saveToLocalStorage();
                updatePlanetList();
            } else {
                console.error('Planet not found with id:', id);
            }
        }

        function generatePlanetColor() {
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8',
                '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B195', '#C06C84',
                '#6C5B7B', '#355C7D', '#F67280', '#C9D787', '#3EDBF0'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function mapImportanceToSize(importance) {
            // 1 = smallest (30px), 10 = largest (400px)
            return CONFIG.MIN_SIZE + (importance - 1) * (CONFIG.MAX_SIZE - CONFIG.MIN_SIZE) / 9;
        }

        function mapUrgencyToSpeed(urgency) {
            // HIGH urgency (10) = SLOW (60 seconds) - lingers to remind you
            // LOW urgency (1) = FAST (1 second) - quick whiz-by
            const minTime = 1; // seconds (for urgency 1)
            const maxTime = 60; // seconds (for urgency 10)
            const time = minTime + (urgency - 1) * (maxTime - minTime) / 9;
            return time;
        }

        function generateOrbitPath() {
            // Generate a unique orbit path with vertical position and curve intensity
            return {
                yCenter: Math.random() * 0.6 + 0.2, // 0.2 to 0.8 of canvas height
                curvature: Math.random() * 0.15 + 0.05, // 0.05 to 0.2
                curveDirection: Math.random() > 0.5 ? 1 : -1 // up or down
            };
        }

        function getTextColor(bgColor) {
            // Convert hex to RGB
            const r = parseInt(bgColor.slice(1, 3), 16);
            const g = parseInt(bgColor.slice(3, 5), 16);
            const b = parseInt(bgColor.slice(5, 7), 16);
            
            // Calculate luminance
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        // ==================== PLANET PHYSICS ====================
        function updatePlanetPhysics(planet, deltaTime) {
            if (planet.waitTime > 0) {
                planet.waitTime -= deltaTime;
                return;
            }
            
            const screenWidth = canvas.width;
            const crossTime = planet.speed * 60; // Convert to frames (assuming 60fps)
            const progressIncrement = (deltaTime / 1000) / planet.speed;
            
            planet.progress += progressIncrement;
            
            if (planet.progress >= 1) {
                // Switch phase and direction
                if (planet.phase === 'foreground') {
                    planet.phase = 'background';
                    planet.direction *= -1;
                    // Wait time between foreground and background using custom interval
                    planet.waitTime = planet.interval * 1000; // Convert seconds to ms
                } else {
                    planet.phase = 'foreground';
                    planet.direction *= -1;
                    // Wait time between background and foreground using custom interval
                    planet.waitTime = planet.interval * 1000;
                }
                planet.progress = 0;
            }
        }

        function getPlanetPosition(planet) {
            const screenWidth = canvas.width;
            const screenHeight = canvas.height;
            
            let x, y, size, opacity, speed;
            
            if (planet.phase === 'foreground') {
                // Foreground: full size, full opacity, normal speed
                size = planet.size;
                opacity = 1;
                speed = 1;
                
                if (planet.direction === 1) {
                    // Moving right
                    x = -size + (screenWidth + size * 2) * planet.progress;
                } else {
                    // Moving left
                    x = screenWidth + size - (screenWidth + size * 2) * planet.progress;
                }
                
                // Curve upward or downward in the center
                const curveProgress = Math.sin(planet.progress * Math.PI);
                y = screenHeight * planet.orbitPath.yCenter + 
                    (curveProgress * screenHeight * planet.orbitPath.curvature * planet.orbitPath.curveDirection);
                
            } else {
                // Background: smaller, darker, slower
                size = planet.size * CONFIG.BACKGROUND_SCALE;
                opacity = CONFIG.BACKGROUND_OPACITY;
                speed = CONFIG.BACKGROUND_SPEED_MULTIPLIER;
                
                if (planet.direction === 1) {
                    // Moving right
                    x = -size + (screenWidth + size * 2) * planet.progress;
                } else {
                    // Moving left
                    x = screenWidth + size - (screenWidth + size * 2) * planet.progress;
                }
                
                // Curve opposite direction in background
                const curveProgress = Math.sin(planet.progress * Math.PI);
                y = screenHeight * planet.orbitPath.yCenter + 
                    (curveProgress * screenHeight * planet.orbitPath.curvature * -planet.orbitPath.curveDirection);
            }
            
            return { x, y, size, opacity };
        }

        // ==================== RENDERING ====================
        function animate() {
            const deltaTime = 16.67; // Approximate 60fps
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw space background
            drawSpace();
            
            // Update and sort planets by layer
            planets.forEach(planet => updatePlanetPhysics(planet, deltaTime));
            
            const backgroundPlanets = planets.filter(p => p.phase === 'background');
            const foregroundPlanets = planets.filter(p => p.phase === 'foreground');
            
            // Draw background planets first
            backgroundPlanets.forEach(planet => drawPlanet(planet));
            
            // Draw foreground planets (sorted by size, bigger on top if overlapping)
            foregroundPlanets.sort((a, b) => a.size - b.size).forEach(planet => drawPlanet(planet));
            
            // Draw active info panel if exists
            if (activePlanetInfo) {
                const planet = planets.find(p => p.id === activePlanetInfo.id);
                if (planet) {
                    drawInfoPanel(planet);
                }
            }
            
            requestAnimationFrame(animate);
        }

        function drawSpace() {
            // Black background
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw twinkling stars
            stars.forEach(star => {
                star.twinkle += star.twinkleSpeed;
                const brightness = (Math.sin(star.twinkle) + 1) / 2 * 0.5 + 0.5; // 0.5 to 1
                ctx.fillStyle = `rgba(255, 255, 255, ${brightness})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        function drawPlanet(planet) {
            const pos = getPlanetPosition(planet);
            
            // Apply opacity for background
            ctx.globalAlpha = pos.opacity;
            
            // Check if this is a background planet and if any foreground planets are casting shadows on it
            if (planet.phase === 'background') {
                const foregroundPlanets = planets.filter(p => p.phase === 'foreground');
                foregroundPlanets.forEach(fgPlanet => {
                    const fgPos = getPlanetPosition(fgPlanet);
                    const distance = Math.sqrt((fgPos.x - pos.x) ** 2 + (fgPos.y - pos.y) ** 2);
                    
                    // If foreground planet is close enough to cast a shadow
                    if (distance < fgPos.size / 2 + pos.size / 2 + 40) {
                        // Calculate shadow offset based on relative position
                        const angle = Math.atan2(pos.y - fgPos.y, pos.x - fgPos.x);
                        const shadowDistance = 8; // How far the shadow is offset
                        const shadowX = pos.x + Math.cos(angle) * shadowDistance;
                        const shadowY = pos.y + Math.sin(angle) * shadowDistance;
                        
                        // Draw shadow
                        const shadowGradient = ctx.createRadialGradient(
                            shadowX, shadowY, 0,
                            shadowX, shadowY, pos.size / 2 + 10
                        );
                        shadowGradient.addColorStop(0, 'rgba(0, 0, 0, 0.4)');
                        shadowGradient.addColorStop(0.7, 'rgba(0, 0, 0, 0.2)');
                        shadowGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                        
                        ctx.fillStyle = shadowGradient;
                        ctx.beginPath();
                        ctx.arc(shadowX, shadowY, pos.size / 2 + 10, 0, Math.PI * 2);
                        ctx.fill();
                    }
                });
            }
            
            // Glow effect on hover
            if (planet.hovering && planet.phase === 'foreground') {
                const gradient = ctx.createRadialGradient(pos.x, pos.y, pos.size / 2, pos.x, pos.y, pos.size / 2 + CONFIG.GLOW_RADIUS);
                gradient.addColorStop(0, planet.color + '00');
                gradient.addColorStop(0.5, planet.color + '40');
                gradient.addColorStop(1, planet.color + '00');
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, pos.size / 2 + CONFIG.GLOW_RADIUS, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Draw planet circle
            ctx.fillStyle = planet.color;
            ctx.beginPath();
            ctx.arc(pos.x, pos.y, pos.size / 2, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw planet name
            ctx.fillStyle = getTextColor(planet.color);
            ctx.font = `${Math.max(pos.size / 8, 12)}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Wrap text to fit planet
            const maxWidth = pos.size * 0.8;
            const words = planet.name.split(' ');
            let lines = [];
            let currentLine = words[0];
            
            for (let i = 1; i < words.length; i++) {
                const testLine = currentLine + ' ' + words[i];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth) {
                    lines.push(currentLine);
                    currentLine = words[i];
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine);
            
            // Draw wrapped text
            const lineHeight = Math.max(pos.size / 8, 12) * 1.2;
            const startY = pos.y - (lines.length - 1) * lineHeight / 2;
            lines.forEach((line, i) => {
                ctx.fillText(line, pos.x, startY + i * lineHeight);
            });
            
            ctx.globalAlpha = 1;
        }

        function drawInfoPanel(planet) {
            const pos = getPlanetPosition(planet);
            
            // Position panel to the right of planet, or left if too close to edge
            const panelWidth = 220;
            const panelHeight = 150;
            let panelX = pos.x + pos.size / 2 + 20;
            let panelY = pos.y - panelHeight / 2;
            
            // Adjust if off screen
            if (panelX + panelWidth > canvas.width) {
                panelX = pos.x - pos.size / 2 - panelWidth - 20;
            }
            if (panelY < 0) panelY = 10;
            if (panelY + panelHeight > canvas.height) panelY = canvas.height - panelHeight - 10;
            
            // Store panel bounds for click detection
            activePlanetInfo.panelBounds = {
                x: panelX,
                y: panelY,
                width: panelWidth,
                height: panelHeight
            };
            
            // Draw panel background
            ctx.fillStyle = 'rgba(20, 20, 30, 0.95)';
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            roundRect(ctx, panelX, panelY, panelWidth, panelHeight, 8);
            ctx.fill();
            ctx.stroke();
            
            // Draw content
            ctx.fillStyle = '#ffffff';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            ctx.fillText(planet.name, panelX + 15, panelY + 15);
            
            ctx.font = '12px sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
            ctx.fillText(`Importance: ${planet.importance}`, panelX + 15, panelY + 45);
            ctx.fillText(`Urgency: ${planet.urgency}`, panelX + 15, panelY + 65);
            ctx.fillText(`Interval: ${planet.interval ? planet.interval.toFixed(1) + 's' : 'Auto'}`, panelX + 125, panelY + 65);
            
            // Draw buttons
            const btnY = panelY + panelHeight - 40;
            const btnHeight = 28;
            const btnPadding = 8;
            
            // Edit button
            activePlanetInfo.editBtn = {
                x: panelX + 15,
                y: btnY,
                width: 60,
                height: btnHeight
            };
            ctx.fillStyle = '#667eea';
            roundRect(ctx, activePlanetInfo.editBtn.x, activePlanetInfo.editBtn.y, 
                      activePlanetInfo.editBtn.width, activePlanetInfo.editBtn.height, 4);
            ctx.fill();
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('Edit', activePlanetInfo.editBtn.x + 30, activePlanetInfo.editBtn.y + 14);
            
            // Delete button
            activePlanetInfo.deleteBtn = {
                x: panelX + 15 + 60 + btnPadding,
                y: btnY,
                width: 60,
                height: btnHeight
            };
            ctx.fillStyle = 'rgba(220, 38, 38, 0.8)';
            roundRect(ctx, activePlanetInfo.deleteBtn.x, activePlanetInfo.deleteBtn.y,
                      activePlanetInfo.deleteBtn.width, activePlanetInfo.deleteBtn.height, 4);
            ctx.fill();
            ctx.fillStyle = '#ffffff';
            ctx.fillText('Delete', activePlanetInfo.deleteBtn.x + 30, activePlanetInfo.deleteBtn.y + 14);
            
            // Cancel button
            activePlanetInfo.cancelBtn = {
                x: panelX + 15 + 120 + btnPadding * 2,
                y: btnY,
                width: 60,
                height: btnHeight
            };
            ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
            roundRect(ctx, activePlanetInfo.cancelBtn.x, activePlanetInfo.cancelBtn.y,
                      activePlanetInfo.cancelBtn.width, activePlanetInfo.cancelBtn.height, 4);
            ctx.fill();
            ctx.fillStyle = '#ffffff';
            ctx.fillText('Cancel', activePlanetInfo.cancelBtn.x + 30, activePlanetInfo.cancelBtn.y + 14);
        }

        function roundRect(ctx, x, y, width, height, radius) {
            ctx.beginPath();
            ctx.moveTo(x + radius, y);
            ctx.lineTo(x + width - radius, y);
            ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
            ctx.lineTo(x + width, y + height - radius);
            ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
            ctx.lineTo(x + radius, y + height);
            ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
            ctx.lineTo(x, y + radius);
            ctx.quadraticCurveTo(x, y, x + radius, y);
            ctx.closePath();
        }

        // ==================== UI INTERACTIONS ====================
        function handleCanvasClick(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Check if clicked on info panel buttons first (before closing side panel)
            if (activePlanetInfo) {
                if (isPointInRect(x, y, activePlanetInfo.editBtn)) {
                    openEditModal(activePlanetInfo.id);
                    activePlanetInfo = null;
                    return;
                }
                if (isPointInRect(x, y, activePlanetInfo.deleteBtn)) {
                    const planetToDelete = planets.find(p => p.id === activePlanetInfo.id);
                    if (planetToDelete) {
                        showConfirmDialog(
                            `Delete "${planetToDelete.name}"?`,
                            () => {
                                deletePlanet(activePlanetInfo.id);
                                activePlanetInfo = null;
                            }
                        );
                    }
                    return;
                }
                if (isPointInRect(x, y, activePlanetInfo.cancelBtn)) {
                    activePlanetInfo = null;
                    return;
                }
                if (isPointInRect(x, y, activePlanetInfo.panelBounds)) {
                    return; // Clicked inside panel but not on buttons
                }
            }
            
            // Close side panel only if clicked on empty canvas area
            const sidePanel = document.getElementById('sidePanel');
            if (sidePanel.classList.contains('open')) {
                // Only close if we didn't click on a planet or info panel
                const clickedPlanet = getPlanetAtPoint(x, y);
                if (!clickedPlanet) {
                    toggleSidePanel();
                }
            }
            
            // Check if clicked on a planet
            const clickedPlanet = getPlanetAtPoint(x, y);
            if (clickedPlanet) {
                activePlanetInfo = { id: clickedPlanet.id };
            } else {
                activePlanetInfo = null;
            }
        }

        function handleCanvasHover(e) {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const hoveredPlanet = getPlanetAtPoint(x, y);
            
            planets.forEach(planet => {
                planet.hovering = planet === hoveredPlanet;
            });
            
            canvas.style.cursor = hoveredPlanet ? 'pointer' : 'default';
        }

        function getPlanetAtPoint(x, y) {
            // Check foreground planets first (reverse order for top layer first)
            const foreground = planets.filter(p => p.phase === 'foreground')
                .sort((a, b) => b.size - a.size);
            
            for (const planet of foreground) {
                const pos = getPlanetPosition(planet);
                const distance = Math.sqrt((x - pos.x) ** 2 + (y - pos.y) ** 2);
                if (distance <= pos.size / 2) {
                    return planet;
                }
            }
            
            return null;
        }

        function isPointInRect(x, y, rect) {
            return x >= rect.x && x <= rect.x + rect.width &&
                   y >= rect.y && y <= rect.y + rect.height;
        }

        function openAddModal() {
            editingPlanetId = null;
            document.getElementById('modalTitle').textContent = 'Add New Idea';
            document.getElementById('submitBtn').textContent = 'Create Planet';
            document.getElementById('planetForm').reset();
            document.getElementById('modal').classList.add('show');
        }

        function openEditModal(planetId) {
            const planet = planets.find(p => p.id === planetId);
            if (!planet) return;
            
            editingPlanetId = planetId;
            document.getElementById('modalTitle').textContent = 'Edit Idea';
            document.getElementById('submitBtn').textContent = 'Save Changes';
            document.getElementById('planetName').value = planet.name;
            document.getElementById('planetImportance').value = planet.importance;
            document.getElementById('planetUrgency').value = planet.urgency;
            document.getElementById('planetInterval').value = planet.interval || '';
            document.getElementById('modal').classList.add('show');
            
            // Open side panel and highlight
            selectedPlanetId = planetId;
            document.getElementById('sidePanel').classList.add('open');
            const toggle = document.getElementById('sidePanelToggle');
            toggle.classList.add('panel-open');
            toggle.textContent = 'âœ•';
            updatePlanetList();
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
            editingPlanetId = null;
        }

        function handleFormSubmit(e) {
            console.log('handleFormSubmit called');
            if (e && e.preventDefault) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            const name = document.getElementById('planetName').value.trim();
            const importance = document.getElementById('planetImportance').value;
            const urgency = document.getElementById('planetUrgency').value;
            const intervalInput = document.getElementById('planetInterval').value.trim();
            const customInterval = intervalInput ? parseFloat(intervalInput) : null;
            
            console.log('Form values:', { name, importance, urgency, customInterval });
            
            if (!name) {
                alert('Please enter an idea name');
                return false;
            }
            if (!importance) {
                alert('Please select importance');
                return false;
            }
            if (!urgency) {
                alert('Please select urgency');
                return false;
            }
            
            if (editingPlanetId) {
                console.log('Updating planet:', editingPlanetId);
                updatePlanet(editingPlanetId, name, importance, urgency, customInterval);
            } else {
                console.log('Creating new planet...');
                const newPlanet = createPlanet(name, importance, urgency, customInterval);
                console.log('Planet created:', newPlanet);
            }
            
            console.log('Total planets now:', planets.length);
            closeModal();
            return false;
        }

        function toggleSidePanel() {
            const panel = document.getElementById('sidePanel');
            const toggle = document.getElementById('sidePanelToggle');
            const isOpen = panel.classList.contains('open');
            
            if (isOpen) {
                panel.classList.remove('open');
                toggle.classList.remove('panel-open');
                toggle.textContent = 'â˜°';
            } else {
                panel.classList.add('open');
                toggle.classList.add('panel-open');
                toggle.textContent = 'âœ•';
            }
        }

        function updatePlanetList() {
            const listContainer = document.getElementById('planetList');
            listContainer.innerHTML = '';
            
            document.getElementById('planetCount').textContent = 
                `${planets.length} planet${planets.length !== 1 ? 's' : ''} orbiting`;
            
            planets.forEach(planet => {
                const item = document.createElement('div');
                item.className = 'planet-item';
                if (planet.id === selectedPlanetId) {
                    item.classList.add('selected');
                }
                
                item.innerHTML = `
                    <div class="planet-item-header">
                        <div class="planet-item-name">${planet.name}</div>
                        <div class="planet-item-color" style="background: ${planet.color}"></div>
                    </div>
                    <div class="planet-item-stats">
                        <div class="planet-item-stat">
                            <span class="planet-item-stat-label">Importance</span>
                            <span class="planet-item-stat-value">${planet.importance}</span>
                        </div>
                        <div class="planet-item-stat">
                            <span class="planet-item-stat-label">Urgency</span>
                            <span class="planet-item-stat-value">${planet.urgency}</span>
                        </div>
                        <div class="planet-item-stat">
                            <span class="planet-item-stat-label">Interval</span>
                            <span class="planet-item-stat-value">${planet.interval ? planet.interval.toFixed(1) + 's' : 'Auto'}</span>
                        </div>
                    </div>
                    <button class="delete-btn" data-id="${planet.id}">Delete</button>
                `;
                
                item.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                        selectedPlanetId = planet.id;
                        updatePlanetList();
                        openEditModal(planet.id);
                    }
                });
                
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showConfirmDialog(
                        `Delete "${planet.name}"?`,
                        () => {
                            deletePlanet(planet.id);
                        }
                    );
                });
                
                listContainer.appendChild(item);
            });
        }

        // ==================== STORAGE ====================
        function saveToLocalStorage() {
            const data = {
                planets: planets.map(p => ({
                    id: p.id,
                    name: p.name,
                    importance: p.importance,
                    urgency: p.urgency,
                    interval: p.interval,
                    color: p.color,
                    orbitPath: p.orbitPath
                }))
            };
            localStorage.setItem('planetIdeas', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const stored = localStorage.getItem('planetIdeas');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    planets = data.planets.map(p => {
                        const speed = mapUrgencyToSpeed(p.urgency);
                        const interval = p.interval !== undefined ? p.interval : calculateDefaultInterval(p.urgency, speed);
                        const planet = {
                            ...p,
                            size: mapImportanceToSize(p.importance),
                            speed: speed,
                            interval: interval,
                            phase: 'foreground',
                            direction: 1,
                            progress: Math.random(), // Random start position
                            waitTime: 0,
                            hovering: false
                        };
                        return planet;
                    });
                    updatePlanetList();
                } catch (e) {
                    console.error('Failed to load from localStorage', e);
                }
            }
        }

        function saveProfile() {
            const data = {
                planets: planets.map(p => ({
                    id: p.id,
                    name: p.name,
                    importance: p.importance,
                    urgency: p.urgency,
                    interval: p.interval,
                    color: p.color,
                    orbitPath: p.orbitPath
                })),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `planet-ideas-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadProfile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        planets = data.planets.map(p => {
                            const speed = mapUrgencyToSpeed(p.urgency);
                            const interval = p.interval !== undefined ? p.interval : calculateDefaultInterval(p.urgency, speed);
                            return {
                                ...p,
                                size: mapImportanceToSize(p.importance),
                                speed: speed,
                                interval: interval,
                                phase: 'foreground',
                                direction: 1,
                                progress: Math.random(),
                                waitTime: 0,
                                hovering: false
                            };
                        });
                        saveToLocalStorage();
                        updatePlanetList();
                        alert('Profile loaded successfully!');
                    } catch (err) {
                        alert('Failed to load profile. Invalid file format.');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // ==================== SUPABASE INTEGRATION (BLUEPRINT) ====================
        /*
        // Uncomment and configure when ready to use Supabase
        
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        async function saveToSupabase() {
            const data = {
                planets: planets.map(p => ({
                    name: p.name,
                    importance: p.importance,
                    urgency: p.urgency,
                    color: p.color,
                    orbitPath: p.orbitPath
                })),
                user_id: 'USER_ID_HERE', // Implement authentication
                updated_at: new Date().toISOString()
            };
            
            const response = await fetch(`${SUPABASE_URL}/rest/v1/planet_profiles`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                alert('Saved to cloud!');
            }
        }
        
        async function loadFromSupabase(profileId) {
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/planet_profiles?id=eq.${profileId}`,
                {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                }
            );
            
            const data = await response.json();
            if (data.length > 0) {
                // Load planets from cloud data
                planets = data[0].planets.map(p => ({
                    ...p,
                    id: Date.now() + Math.random(),
                    size: mapImportanceToSize(p.importance),
                    speed: mapUrgencyToSpeed(p.urgency),
                    phase: 'foreground',
                    direction: 1,
                    progress: Math.random(),
                    waitTime: 0,
                    hovering: false
                }));
                saveToLocalStorage();
                updatePlanetList();
            }
        }
        */

        // ==================== START ====================
        init();
    </script>
</body>
</html>
